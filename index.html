<!DOCTYPE html><html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>إضافة الصفقات</title>
<style>
  /* نفس التنسيقات الموجودة بدون تغيير */
  /* ... تم الإبقاء على جميع التنسيقات كما هي في كودك السابق ... */
</style>
</head>
<body>  <h2>إضافة الصفقات</h2>  <form id="tradeForm">
    <label for="pair">زوج التداول:</label>
    <select id="pair" name="pair" required>
      <option value="EUR/USD">EUR/USD</option>
      <option value="XAU/USD">XAU/USD</option>
      <option value="BTC/USD">BTC/USD</option>
      <option value="USD/JPY">USD/JPY</option>
    </select><label for="type">نوع الصفقة:</label>
<select id="type" name="type" required>
  <option value="شراء">شراء</option>
  <option value="بيع">بيع</option>
</select>

<label for="entry">سعر الدخول:</label>
<input type="number" step="0.0001" id="entry" name="entry" required />

<label for="sl">وقف الخسارة:</label>
<input type="number" step="0.0001" id="sl" name="sl" required />

<label for="tp">الهدف:</label>
<input type="number" step="0.0001" id="tp" name="tp" required />

<label for="image">صورة الصفقة (اختياري):</label>
<input type="file" id="image" accept="image/*" />

<div class="checkbox-container">
  <input type="checkbox" id="conditionsCheck" />
  <label for="conditionsCheck">تم توفر جميع الشروط</label>
</div>

<button type="submit" id="addTradeBtn" disabled>إضافة الصفقة مؤقتًا</button>

  </form>  <table aria-label="جدول الصفقات المؤقتة">
    <thead>
      <tr>
        <th>#</th>
        <th>الزوج</th>
        <th>النوع</th>
        <th>دخول</th>
        <th>وقف</th>
        <th>هدف</th>
        <th>أرشفة</th>
      </tr>
    </thead>
    <tbody id="pendingTradesBody">
      <!-- الصفقات المؤقتة تظهر هنا -->
    </tbody>
  </table>  <div id="fabButton" title="سجل الصفقات" aria-label="سجل الصفقات" role="button" tabindex="0">📅</div><script>
  let pendingTrades = JSON.parse(sessionStorage.getItem('pendingTrades') || '[]');
  let savedTrades = JSON.parse(localStorage.getItem('trades') || '[]');

  const tbody = document.getElementById('pendingTradesBody');
  const form = document.getElementById('tradeForm');
  const imageInput = document.getElementById('image');
  const conditionsCheck = document.getElementById('conditionsCheck');
  const addTradeBtn = document.getElementById('addTradeBtn');
  const fabButton = document.getElementById('fabButton');

  conditionsCheck.addEventListener('change', () => {
    addTradeBtn.disabled = !conditionsCheck.checked;
  });

  function renderPendingTrades() {
    tbody.innerHTML = '';
    pendingTrades.forEach((trade, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${trade.pair}</td>
        <td>${trade.type}</td>
        <td>${trade.entry}</td>
        <td>${trade.sl}</td>
        <td>${trade.tp}</td>
        <td><span class="archiveIcon" title="أرشفة الصفقة" onclick="archiveTrade(${index})">✓</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  form.addEventListener('submit', e => {
    e.preventDefault();

    if (!conditionsCheck.checked) {
      alert("يجب تفعيل 'تم توفر جميع الشروط' قبل إضافة الصفقة.");
      return;
    }

    const file = imageInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        saveTrade(evt.target.result); // Base64 URL للصورة
      };
      reader.readAsDataURL(file);
    } else {
      saveTrade(null);
    }
  });

  function saveTrade(imageData) {
    const newTrade = {
      pair: form.pair.value,
      type: form.type.value,
      entry: form.entry.value,
      sl: form.sl.value,
      tp: form.tp.value,
      timestamp: new Date().toISOString(),
      result: 'جارية',
      image: imageData // Base64 or null
    };

    pendingTrades.push(newTrade);
    sessionStorage.setItem('pendingTrades', JSON.stringify(pendingTrades));

    renderPendingTrades();
    form.reset();
    addTradeBtn.disabled = true;
    conditionsCheck.checked = false;
  }

  function archiveTrade(index) {
    const trade = pendingTrades[index];
    savedTrades.push(trade);
    pendingTrades.splice(index, 1);

    sessionStorage.setItem('pendingTrades', JSON.stringify(pendingTrades));
    localStorage.setItem('trades', JSON.stringify(savedTrades));

    renderPendingTrades();
    alert('تم أرشفة الصفقة بنجاح.');
  }

  fabButton.addEventListener('click', () => {
    window.location.href = 'cleanlog.html';
  });

  fabButton.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      fabButton.click();
    }
  });

  renderPendingTrades();

  // --------- سحب الزر العائم مع حفظ الموقع ----------
  let isDragging = false;
  let offsetX, offsetY;

  const savedPosition = JSON.parse(localStorage.getItem('fabPosition'));
  if (savedPosition) {
    fabButton.style.bottom = 'unset';
    fabButton.style.right = 'unset';
    fabButton.style.top = savedPosition.top;
    fabButton.style.left = savedPosition.left;
  }

  function startDrag(e) {
    isDragging = true;
    const rect = fabButton.getBoundingClientRect();
    offsetX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    offsetY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('touchend', stopDrag);
  }

  function drag(e) {
    if (!isDragging) return;
    e.preventDefault();

    const x = (e.touches ? e.touches[0].clientX : e.clientX) - offsetX;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - offsetY;

    fabButton.style.left = x + 'px';
    fabButton.style.top = y + 'px';
    fabButton.style.bottom = 'unset';
    fabButton.style.right = 'unset';
  }

  function stopDrag() {
    isDragging = false;
    localStorage.setItem('fabPosition', JSON.stringify({
      top: fabButton.style.top,
      left: fabButton.style.left
    }));

    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
    document.removeEventListener('touchmove', drag);
    document.removeEventListener('touchend', stopDrag);
  }

  fabButton.addEventListener('mousedown', startDrag);
  fabButton.addEventListener('touchstart', startDrag, { passive: false });
</script></body>
</html>